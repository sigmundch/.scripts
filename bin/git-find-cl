#!/usr/bin/env dart
import 'dart:io' show Process;

/// This script finds landed `git cl` branches and prints them.
/// The output can be piped to `xargs git branch -D` for example.
main(args) {
  bool findDead = true;
  bool findLive = true;
  String issueId;
  if (args.length > 0) {
    if (args[0] == 'dead') {
      findLive = false;
    } else if (args[0] == 'live') {
      findDead = false;
    } else {
      issueId = args[0];
    }
  }

  var result = Process.runSync('git', ['config', '-l']);
  if (result.exitCode != 0) exit(result.exitCode);
  var matches = new RegExp(r'^branch\.(.+)\.([^\.=]+)=(\w+)', multiLine: true)
      .allMatches(result.stdout);
  var info = {};
  for (var match in matches) {
    var name = match[1];
    var branch = info.putIfAbsent(name, () => new Branch(name));
    if (match[2] == 'rietveldserver') branch.hasServer = true;
    if (match[2] == 'rietveldissue') branch.issueId = match[3];
  }
  for (var branch in info.values) {
    if (findDead && !branch.isLive) branch.prettyPrint();
    if (findLive && branch.isLive) {
      branch.prettyPrint(highlight: issueId == branch.issueId);
    }
  }
}

class Branch {
  final String name;
  get isLive => hasServer && issueId != null;
  bool hasServer;
  String issueId;
  Branch(this.name);

  prettyPrint({bool highlight}) {
    var liveColor = highlight ? '32;1m' : '32m';
    var sb = new StringBuffer()
      ..write(name)
      ..write(':')
      ..write(' ' * (30 - name.length))
      ..write(isLive ? '[$liveColor' : '[31m')
      ..write(isLive ? (highlight ? '$issueId <--' : issueId) : 'dead')
      ..write('[0m');
    print('$sb');
  }
}

// vim: set filetype=dart:
